<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REDLIGHT // SIGNAL</title>
  <style>
    :root{
      --bg:#05060b;
      --panel:#0b0c14;
      --red: 255, 50, 70;     /* base red */
      --glow: 255, 40, 60;    /* glow red */
    }

    html,body{height:100%; margin:0; background:var(--bg); overflow:hidden;}
    body{
      display:grid;
      place-items:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .scene{
      width:min(900px, 96vw);
      aspect-ratio: 1 / 1;
      position:relative;
      z-index:0;
      border:1px solid rgba(255,255,255,0.06);
      border-radius:16px;
      overflow:hidden;

      /* Background image + overlays (image first, overlays on top) */
      background-image:
        url("redlightdoor.png"),
        radial-gradient(1200px 700px at 50% 20%, rgba(255,60,80,0.08), transparent 55%),
        linear-gradient(180deg, rgba(7,8,18,0.35), rgba(3,3,9,0.35));

      background-size: cover, cover, cover;
      background-position: center, center, center;
      background-repeat: no-repeat, no-repeat, no-repeat;

      box-shadow: 0 20px 80px rgba(0,0,0,0.55);
    }

    /* Position the light above the door. Adjust left/top to match your picture */
    .lamp{
      position:absolute;
      left:50%;
      top:18%;
      transform:translate(-50%, -50%);
      width:220px;
      height:120px;
      display:grid;
      place-items:center;
      pointer-events:none;
      filter: drop-shadow(0 0 10px rgba(var(--glow), 0.25));
      z-index:5;
    }

    .housing{
      width:190px;
      height:40px;
      border-radius:10px;
      background: linear-gradient(180deg, #141521, #0b0c14);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .bulb{
      width:150px;
      height:14px;
      border-radius:8px;
      background: rgba(var(--red), 0.35);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,0.25),
        0 0 12px rgba(var(--glow), 0.25);
      transition: background 90ms linear, box-shadow 90ms linear, opacity 90ms linear;
      opacity: 0.6;
    }

    .cone{
      position:absolute;
      top:48px;
      left:50%;
      transform:translateX(-50%);
      width:520px;
      height:360px;
      background: radial-gradient(closest-side at 50% 0%,
        rgba(var(--glow), 0.28),
        rgba(var(--glow), 0.10) 35%,
        rgba(var(--glow), 0.00) 70%);
      opacity:0.0;
      transition: opacity 90ms linear;
      mix-blend-mode: screen;
    }

    .on .bulb{
      opacity: 1;
      background: rgba(var(--red), 0.95);
      box-shadow:
        0 0 18px rgba(var(--glow), 0.8),
        0 0 60px rgba(var(--glow), 0.4);
      border-color: rgba(255,255,255,0.22);
    }
    .on .cone{ opacity: 1; }

    .badge{
      position:absolute;
      left:14px;
      bottom:14px;
      padding:10px 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      color: rgba(190, 252, 255, 0.85);
      font-size: 12px;
      user-select:none;
      z-index:6;
    }

    /* Visual confirmation when JSON payload is successfully fetched */
    .signal-unlocked .bulb{
      background: rgba(255, 90, 90, 0.98);
      box-shadow:
        0 0 25px rgba(255, 60, 80, 0.95),
        0 0 90px rgba(255, 60, 80, 0.5);
    }
    .signal-unlocked .badge{
      color:#ffb3ba;
      border-color: rgba(255,80,90,0.6);
    }
  </style>
</head>
<body>
  <div class="scene" id="scene">
    <div class="lamp" id="lamp">
      <div class="housing">
        <div class="bulb" id="bulb"></div>
      </div>
      <div class="cone" id="cone"></div>
    </div>

    <div class="badge" id="badge">REDLIGHT // Morse beacon active</div>
  </div>

<script>
/* =========================
   MORSE BEACON
   ========================= */
const TEXT = "CHECK THE DEV TOOLS F12";
const UNIT_MS = 120;
const scene = document.getElementById("scene");
const badge = document.getElementById("badge");

const MORSE = {
  A: ".-",    B: "-...",  C: "-.-.",  D: "-..",   E: ".",
  F: "..-.",  G: "--.",   H: "....",  I: "..",    J: ".---",
  K: "-.-",   L: ".-..",  M: "--",    N: "-.",    O: "---",
  P: ".--.",  Q: "--.-",  R: ".-.",   S: "...",   T: "-",
  U: "..-",   V: "...-",  W: ".--",   X: "-..-",  Y: "-.--",
  Z: "--..",
  "0":"-----","1":".----","2":"..---","3":"...--","4":"....-",
  "5":".....","6":"-....","7":"--...","8":"---..","9":"----."
};

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function lampOn(on){ scene.classList.toggle("on", on); }

function buildTimeline(message){
  const out = [];
  const words = message.toUpperCase().split(" ");

  for (let w = 0; w < words.length; w++){
    const word = words[w];

    for (let ci = 0; ci < word.length; ci++){
      const ch = word[ci];
      const code = MORSE[ch];
      if (!code) continue;

      for (let si = 0; si < code.length; si++){
        const s = code[si];
        out.push({ on:true, units: (s === ".") ? 1 : 3 });
        if (si !== code.length - 1) out.push({ on:false, units: 1 });
      }
      if (ci !== word.length - 1) out.push({ on:false, units: 3 });
    }
    if (w !== words.length - 1) out.push({ on:false, units: 7 });
  }
  return out;
}

let beaconRunning = true;

async function loopBeacon(){
  const timeline = buildTimeline(TEXT);
  lampOn(false);
  await sleep(UNIT_MS * 6);

  while(true){
    if (!beaconRunning) {
      lampOn(true); // lock-on when unlocked
      await sleep(250);
      continue;
    }

    for (const step of timeline){
      if (!beaconRunning) break;
      lampOn(step.on);
      await sleep(step.units * UNIT_MS);
    }
    lampOn(false);
    await sleep(UNIT_MS * 10);
  }
}

loopBeacon();


/* =========================
   DEVTOOLS DETECT + HIDDEN JSON FETCH
   Only runs when DevTools are open on refresh.
   ========================= */
const THRESHOLD = 160;

// file to fetch (rename to something boring if you want)
const HIDDEN_JSON = "cdn-manifest.json";

function devToolsOpen(){
  return (
    window.outerWidth - window.innerWidth > THRESHOLD ||
    window.outerHeight - window.innerHeight > THRESHOLD
  );
}

async function fetchHiddenJSON(){
  try {
    const url = `${HIDDEN_JSON}?ts=${Date.now()}`; // cache-bust so it shows in Network
    const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });
    const data = await res.json();

    // Visual confirmation
    document.body.classList.add("signal-unlocked");
    badge.textContent = "REDLIGHT // Signal acquired";

    // Stop Morse and lock the lamp on
    beaconRunning = false;

    console.clear();
    console.log("%cREDLIGHT: manifest sync", "color:#ff3b4a;font-weight:bold;font-size:14px;");
    console.table(data);

    // If you include a base64 HTML payload in JSON, decode it:
    if (data && typeof data.payload === "string" && data.payload.length > 0) {
      const html = atob(data.payload);

      // Option A: reveal in console (CTF-friendly)
      console.log("%cPAYLOAD (decoded):", "color:#bffcff;font-weight:bold;");
      console.log(html);

      // Option B: inject into the page (uncomment if you want it to appear)
      // document.body.insertAdjacentHTML("beforeend", html);
    }
  } catch (e) {
    console.warn("Signal fetch failed:", e);
  }
}

window.addEventListener("load", () => {
  if (devToolsOpen()) {
    fetchHiddenJSON();
  }
});
</script>
</body>
</html>
